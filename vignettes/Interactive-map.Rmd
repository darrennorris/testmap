---
title: "Population change map"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Interactive-map}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

<!-- Google Translate widget -->
<div id="google_translate_element" style="float: right;"></div>
<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en', includedLanguages: 'ar,bn,pt,en,nl,es,fr,de,it,iw,hi,ja,ko,zh-CN'}, 'google_translate_element');
}
</script>
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>


```{r setup, echo=FALSE}
library(testmap)
```


```{r load-packages, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(leaflet)
library(leafem)
library(sf)
library(knitr)
library(kableExtra)
library(htmltools)
```
Use the interactive map below to check population changes. Zoom in to see 
where *Podocnemis unilfilis* is Endangered based on IUCN Redlist criteria - A3bd.

This is an extension of [Norris et. al. 2019](https://doi.org/10.1016/j.biocon.2019.02.022) that includes:

- Stochastic population projections. 
- Future impacts to populations caused by human acessibility (hunting and habitat change) and actions that reduce river connectivity.

## Map
Due to the number of points, the map can become slow to respond when you zoom in.
Zoom out to a level showing fewer points and you can pan around the map 
to find the area of interest. Then zoom in again to check the coloured points.

### Free-flowing rivers
```{r make-map-ffr, echo=FALSE, message=FALSE, warning=FALSE}
points_bau4326 <- sf::st_as_sf(points_bau_ffr_map, crs = 3395) |> 
  st_transform(4326) 
levels(points_bau4326$flag_50_42y) <- c("No", "Yes")
points_bau4326_low <- points_bau4326
# label to plot with circle
points_bau4326_low$label <- paste("Prot = ", points_bau4326_low$Protected, 
                                  "Acc = ", points_bau4326_low$Accessible, 
                                  "Free = ", points_bau4326_low$Free.flowing)
# colour palette
leaf_pal <- colorFactor(
  palette = c("#7274C1", "#A3720E"), 
  domain = points_bau4326$flag_50_42y
)

mypal <- c("#7274C1", "#A3720E")

# interactive map. Optins added to make panning smoother....
leaflet::leaflet(points_bau4326_low, 
                 options = leafletOptions(preferCanvas = TRUE)) |> 
  addTiles(options = tileOptions(
  updateWhenZooming = FALSE,      # map won't update tiles until zoom is done
  updateWhenIdle = TRUE)) |> 
  addCircles(color = ~leaf_pal(flag_50_42y), 
             popup = ~htmlEscape(label),
             group = "points_bau4326_low"
) |>  
  addCircleMarkers(color = ~leaf_pal(flag_50_42y), 
             stroke = FALSE, fillOpacity = 0.4, 
clusterOptions = markerClusterOptions(), 
group = "points_bau4326"
) |> 
  addLegend("bottomright", pal = leaf_pal, title="Endangered",
            values = ~flag_50_42y,
            group = "en_legend") |> 
  groupOptions("points_bau4326", zoomLevels = 1:7) |> 
  groupOptions("points_bau4326_low", zoomLevels = 8:15) |> 
  groupOptions("en_legend", zoomLevels = 8:15) |> 
  addScaleBar() |> 
  leafem::addMouseCoordinates()
  
```

When you zoom in you will see shaded points. Points are brown where 
populations are expected to decline by 50% or more within 3 generations (42 years).
Brown points therefore represent rivers where the species is Endangered, 
following the IUCN Redlist criteria - A3bd.

### River points Norris et. al. 2019
Map below uses the river points from Norris et. al. 2019.
```{r make-map-norris, echo=FALSE, message=FALSE, warning=FALSE}
points_bau4326 <- points_bau |> 
  #filter(BASIN_N == "Orinoco") |>
  arrange(BASIN_N, SUBBASI, BB_ID, REACH_ID) |> 
  filter(row_number() %% 5 == 1) |> st_as_sf(crs = 3395) |> st_transform(4326) 
levels(points_bau4326$flag_50_42y) <- c("No", "Yes")
points_bau4326_low <- points_bau4326
# label to plot with circle
points_bau4326_low$label <- paste("Prot = ", points_bau4326_low$Protected, 
                                  "Acc = ", points_bau4326_low$Accessible, 
                                  "Free = ", points_bau4326_low$Free.flowing)
# colour palette
leaf_pal <- colorFactor(
  palette = c("#7274C1", "#A3720E"), 
  domain = points_bau4326$flag_50_42y
)

mypal <- c("#7274C1", "#A3720E")
 # basemap with tile control. not working.
basemap <- leaflet::leaflet() %>%
  # add different provider tiles
  addProviderTiles(
    "OpenStreetMap",
    # give the layer a name
    group = "OpenStreetMap"
  ) %>%
  addProviderTiles(
    "Stamen.Terrain",
    group = "Stamen.Terrain"
  ) %>%
  addProviderTiles(
    "Esri.WorldImagery",
    group = "Esri.WorldImagery"
  ) %>%
# add a layers control
  addLayersControl(
    baseGroups = c(
      "OpenStreetMap", "Stamen.Terrain", "Esri.WorldImagery"
    ),
    # position it on the topleft
    position = "topleft"
  )

# interactive map. Optins added to make panning smoother....
leaflet::leaflet(points_bau4326_low, 
                 options = leafletOptions(preferCanvas = TRUE)) |> 
  addTiles(options = tileOptions(
  updateWhenZooming = FALSE,      # map won't update tiles until zoom is done
  updateWhenIdle = TRUE)) |> 
  addCircles(color = ~leaf_pal(flag_50_42y), 
             popup = ~htmlEscape(label),
             group = "points_bau4326_low"
) |>  
  addCircleMarkers(color = ~leaf_pal(flag_50_42y), 
             stroke = FALSE, fillOpacity = 0.4, 
clusterOptions = markerClusterOptions(), 
group = "points_bau4326"
) |> 
  addLegend("bottomright", pal = leaf_pal, title="Endangered",
            values = ~flag_50_42y,
            group = "en_legend") |> 
  groupOptions("points_bau4326", zoomLevels = 1:8) |> 
  groupOptions("points_bau4326_low", zoomLevels = 9:15) |> 
  groupOptions("en_legend", zoomLevels = 9:15) |> 
  addScaleBar() |> 
  leafem::addMouseCoordinates()
  
  
```

When you zoom in you will see shaded points. Points are brown where 
populations are expected to decline by 50% or more within 3 generations (42 years).
Brown points therefore represent rivers where the species is Endangered, 
following the IUCN Redlist criteria - A3bd.

## Tables
A summary of the results is presented below. Summaries by country and 
major basin.

```{r totals-access, echo=FALSE, warning=FALSE, message=FALSE, eval=FALSE}
# Check length of free flowing by Accessibility.
points_bau |> 
  mutate(flag_ff = if_else(Free.flowing == "yes", 1, 0)) |>
  group_by(Accessible) |> 
  summarise(length_river = n(), 
           length_ff = sum(flag_ff)) |> 
  ungroup() |> 
  mutate(prop_ff = round((length_ff / length_river), 2), 
         length_notff = (length_river - length_ff)) |> 
  select(Accessible, prop_ff, length_river, length_ff, length_notff) 
  
```

### Summary by country.
```{r totals-country, echo=FALSE, warning=FALSE, message=FALSE}
table_country <- points_bau |> 
  mutate(flag_ff = if_else(Free.flowing == "yes", 1, 0)) |>
  group_by(COUNTRY, Accessible) |> 
  mutate(flag_e = if_else(fem_diff_t42 <= -0.5, 1, 0)) |>
  summarise(length_river = n(), 
            length_end = sum((flag_e)), 
           length_ff = sum(flag_ff), 
           prop_ff = round((sum(flag_ff) / length_river), 2)) |> 
    ungroup() |> 
    mutate(length_not_end = length_river - length_end, 
           prop_end = round((length_end / length_river), 2), 
           length_not_ff = length_river - length_ff
           
) |> 
  select(COUNTRY, Accessible, prop_end, length_river, length_end, length_not_end, 
         prop_ff, length_ff, length_not_ff)

# Sum rows of each column if numeric 
func <- function(z) if (is.numeric(z)) sum(z) else '' 
sumrow <- as.data.frame(lapply(table_country, func))
# Give name to the first element of the new data frame created above
sumrow[1] <- "Total"
# remove unwanted value
sumrow[c(2, 3, 7)] <- NA
```

```{r make-table-country, echo=FALSE}
options(knitr.kable.NA = '')

bind_rows(table_country, sumrow) |> 
  #select(COUNTRY, prop_end, length_river, length_end, length_not_end) |>
knitr::kable(col.names = c("Country", "Accessible" ,"Endangered (prop)","river length (km)", 
                           "length End.", "length not End.", 
                           "Free Flowing (prop)", "length ff", "length not ff")) |> 
  kableExtra::column_spec(3:9, width = "2.5cm")
             
```

### Summary by basin.
Using results from updated Norris et. al. 2019.
```{r totals-basin, echo=FALSE, message=FALSE, warning=FALSE}
table_basin <- points_bau |> 
  group_by(BASIN_N) |> 
  mutate(flag_e = if_else(fem_diff_t42 <= -0.5, 1, 0)) |>
  summarise(length_river = n(), 
            length_end = sum((flag_e))) |> 
    ungroup() |> 
    mutate(length_not_end = length_river - length_end, 
           prop_end = round((length_end / length_river), 2)) |> 
  select(BASIN_N, prop_end, length_river, length_end, length_not_end)
```

```{r make-table-basin, echo=FALSE}
knitr::kable(table_basin, 
             col.names = c("Basin", "Endangered (prop)","river length (km)", 
                           "length End.", "length not End.")) 
             
```

Same using Free-flowing rivers data.
```{r totals-basin-ffr, echo=FALSE, message=FALSE, warning=FALSE}
table_basin_ffr <- points_bau_ffr |> 
  group_by(BASIN_NAME) |> 
  mutate(flag_e = if_else(fem_diff_t42 <= -0.5, 1, 0)) |>
  summarise(length_river = n(), 
            length_end = sum((flag_e))) |> 
    ungroup() |> 
    mutate(length_not_end = length_river - length_end, 
           prop_end = round((length_end / length_river), 2)) |> 
  select(BASIN_NAME, prop_end, length_river, length_end, length_not_end)
```

```{r make-table-basin-ffr, echo=FALSE}
knitr::kable(table_basin_ffr, 
             col.names = c("Basin", "Endangered (prop)","river length (km)", 
                           "length End.", "length not End.")) 
             
```


### Summary by major basins and countries.
```{r totals-basin-country, echo=FALSE, message=FALSE, warning=FALSE}
table_basin_country <- points_bau |> 
  group_by(BASIN_N, COUNTRY) |> 
  mutate(flag_e = if_else(fem_diff_t42 <= -0.5, 1, 0)) |>
  summarise(length_river = n(), 
            length_end = sum((flag_e))) |> 
    ungroup() |> 
    mutate(length_not_end = length_river - length_end, 
           prop_end = round((length_end / length_river), 2)) |> 
  select(BASIN_N, COUNTRY, prop_end, length_river, length_end, length_not_end)
```

```{r make-table-basin-country, echo=FALSE}
knitr::kable(table_basin_country, 
             col.names = c("Basin", "Country","Endangered (prop)", 
                           "river length (km)", 
                           "length End.", "length not End.")) |> 
  kableExtra::column_spec(3:6, width = "3cm")
             
```

Same with Free-flowing rivers.....
```{r totals-basin-country-ffr, echo=FALSE, message=FALSE, warning=FALSE}
table_basin_country_ffr <- points_bau_ffr |> 
  group_by(BASIN_NAME, COUNTRY) |> 
  mutate(flag_e = if_else(fem_diff_t42 <= -0.5, 1, 0)) |>
  summarise(length_river = n(), 
            length_end = sum((flag_e))) |> 
    ungroup() |> 
    mutate(length_not_end = length_river - length_end, 
           prop_end = round((length_end / length_river), 2)) |> 
  select(BASIN_NAME, COUNTRY, prop_end, length_river, length_end, length_not_end)
```

```{r make-table-basin-country-ffr, echo=FALSE}
knitr::kable(table_basin_country_ffr, 
             col.names = c("Basin", "Country","Endangered (prop)", 
                           "river length (km)", 
                           "length End.", "length not End.")) |> 
  kableExtra::column_spec(3:6, width = "3cm")
             
```


## Next steps

 - Update using points from Free Flowing Rivers    
 <https://www.worldwildlife.org/pages/free-flowing-rivers>
